<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ProMan — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .payment-hover {
            transition: background-color .15s, color .15s;
        }
        .payment-hover:hover {
            background-color: #FFF8E7;
            color: #8B5E3C;
            cursor: pointer;
        }
        .indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.9rem;
            height: 1.9rem;
            border-radius: 0.5rem;
            font-weight: 700;
            user-select: none;
        }
        .row-selected {
            background-color: #f7f7f7;
            box-shadow: inset 0 0 0 2px rgba(210, 180, 140, 0.12);
        }
        .progress-dot {
            width: 14px;
            height: 14px;
            border-radius: 9999px;
            display: inline-block;
            background: #D9CBB8;
            border: 2px solid transparent;
        }
        :root {
            --accent: #8B5E3C;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 antialiased min-h-screen">
<header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <img src="/umuzi/img/mypromann.png" alt="ProMan logo" class="h-16 md:h-20 w-auto object-contain">
            <div class="leading-tight">
                <a href="home.html" class="text-lg md:text-xl font-extrabold text-[#8B5E3C]">ProMan</a>
                <div class="text-xs text-gray-500 -mt-1">Property management simplified</div>
            </div>
        </div>

        <nav class="space-x-6 text-gray-600 text-lg font-medium flex items-center">
            <a href="http://localhost:7070/" class="hover:text-[#8B5E3C] transition">Home</a>
            <a href="http://localhost:7070/dashboard" class="hover:text-[#8B5E3C] transition font-bold">Dashboard</a>
            <a href="http://localhost:7070/" class="hover:text-[#8B5E3C] transition">Logout</a>
        </nav>
    </div>
</header>

<main class="max-w-6xl mx-auto px-6 pb-12">

    <div class="flex flex-col lg:flex-row gap-10 mb-6 items-stretch">
        <div class="lg:w-1/3 h-full">
            <div class="bg-white rounded-lg shadow p-6 h-full flex flex-col">
                <form id="propertyForm" action="http://localhost:7070/fetch_property_units" method="post">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Property Name</label>
                            <select id="propertySelect" name="name" class="w-full rounded-md border-gray-300 shadow-sm focus:ring-0">
                                <option value="">Select property</option>
                                <option value="all">All properties</option>
                                <option th:each="name : ${names}" th:value="${name}" th:text="${name}">Default Name</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Search tenant</label>
                            <input id="tenantSearch" type="search" placeholder="Search by tenant name (e.g. John Doe)"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:ring-0" />
                        </div>
                    </div>
                </form>

                <div class="mt-4 flex-1">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Property Image</label>
                    <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center h-60">
                        <img src="/umuzi/img/mypromann.png" alt="Property image" class="max-h-full max-w-full object-contain">
                    </div>
                </div>

                <div class="mt-4">
                    <h2><a href="http://localhost:7070/add_property_unit" class="text-[#8B5E3C] hover:underline">Add New property</a></h2>
                </div>

                <p class="mt-4 text-sm text-gray-500">
                    Tip: Select a row, then use the external controls (+ / -) to update only the Payment box. Overdue shows number of days overdue.
                </p>
            </div>
        </div>

        <div class="lg:w-2/3 h-full">
            <div class="bg-white rounded-lg shadow p-6 h-full flex flex-col">
                <div id="controlsWrapper" class="mb-4 flex flex-wrap gap-3 items-center">
                    <button id="btnPaid" type="button" class="px-4 py-2 rounded-md bg-green-600 text-white font-semibold shadow hover:bg-green-700">
                        Mark Paid (+)
                    </button>
                    <button id="btnUnpaid" type="button" class="px-4 py-2 rounded-md bg-red-600 text-white font-semibold shadow hover:bg-red-700">
                        Mark Unpaid (-)
                    </button>
                    <div class="text-sm text-gray-600 ml-2">Select a row, then click a button to update the Payment box only.</div>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="min-w-full border border-[#D2B48C] rounded-lg shadow-md bg-white">
                        <thead class="bg-[#FAF3E0] border-b border-[#D2B48C]">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">Unit Number</th>
                            <th class="px-4 py-3 text-left font-semibold">Rent</th>
                            <th class="px-4 py-3 text-left font-semibold">Occupation</th>
                            <th class="px-4 py-3 text-left font-semibold">Tenant</th>
                            <th class="px-4 py-3 text-left font-semibold">Rent Day</th>
                            <th class="px-4 py-3 text-left font-semibold">Overdue(days)</th>
                            <th class="px-4 py-3 text-left font-semibold">Status</th>
                        </tr>
                        </thead>
                        <tbody id="unitsTbody">
                        <tr th:each="entry : ${units}" class="border-b border-gray-200">
                            <td class="px-4 py-3 unit-number" th:text="${entry.value[0]}">Unit</td>
                            <td class="px-4 py-3 rent-amount" th:text="${entry.value[1]}">0</td>
                            <td class="px-4 py-3" th:text="${entry.value[2]}">yes</td>
                            <td class="px-4 py-3 unit-id" th:text="${entry.value[3]}">0</td>
                            <td class="px-4 py-3 unit-tenant" th:text="${entry.value[4]}">70</td>
                            <td class="px-4 py-3 unit-tenant" th:text="${entry.value[5]}">0</td>
                            <td class="px-4 py-3 payment-hover payment-cell">
                                <span th:if="${entry.value[2]} == 'yes'"
                                      class="indicator bg-green-100 text-green-800 open-pay"
                                      th:data-unit="${entry.value[0]}"
                                      th:data-rent="${entry.value[1]}"
                                      th:data-id="${entry.value[3]}">+</span>
                                <span th:if="${entry.value[2]} == 'no'" class="indicator bg-red-100 text-red-800">−</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center">
        <h2 class="text-lg font-semibold mb-3">Update Payment Status</h2>
        <p class="text-gray-700 mb-2">Unit: <span id="modalUnitDisplay" class="font-bold"></span></p>
        <p class="text-gray-700 mb-4 text-sm">Original Rent: <span id="modalOriginalRent" class="font-bold"></span></p>

        <form id="paymentForm" action="http://localhost:7070/payment_status" method="post">
            <input type="hidden" name="unit" id="modalUnit">
            <input type="hidden" name="id" id="modalId">
            <input type="hidden" name="paid" value="yes">

            <div class="mb-4">
                <label for="modalRentInput" class="block text-sm font-medium text-gray-700 mb-2 text-left">
                    Rent Paid Amount:
                </label>
                <input type="number"
                       id="modalRentInput"
                       name="rent"
                       step="0.01"
                       min="0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#8B5E3C] focus:border-transparent"
                       placeholder="Enter rent amount">
            </div>

            <div class="flex gap-3">
                <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    Confirm Payment
                </button>
                <button type="button" onclick="closePaymentModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<footer class="mt-12 py-10 bg-white border-t">
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600">
        <div>
            <a href="home.html" class="text-lg font-extrabold text-[#8B5E3C]">ProMan</a>
            <p class="text-sm text-gray-500 mt-2">Make property management simple and reliable.</p>
        </div>

        <div class="flex flex-col">
            <h4 class="font-semibold text-gray-700 mb-2">Product</h4>
            <a href="dashboard.html" class="text-sm text-gray-600 hover:underline">Dashboard</a>
            <a href="signup.html" class="text-sm text-gray-600 hover:underline mt-1">Log in</a>
            <a href="http://localhost:7070/ayi" class="text-sm text-gray-600 hover:underline mt-1">Sign up</a>
        </div>

        <div class="text-right md:text-left">
            <div>© ProMan — Property Management</div>
            <a href="mailto:ProMan@gmail.com" class="text-[#8B5E3C] hover:underline">ProMan@gmail.com</a>
        </div>
    </div>
</footer>

<script>
    const propertySelect = document.getElementById('propertySelect');
    const tenantSearch = document.getElementById('tenantSearch');
    const tbody = document.getElementById('unitsTbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    function applyFilters() {
        const prop = propertySelect.value;
        const tenantQuery = tenantSearch.value.trim().toLowerCase();
        rows.forEach(row => {
            const rowProp = row.dataset.property || '';
            const rowTenant = row.dataset.tenant || '';
            const matchesProp = (prop === 'all') || (rowProp === prop);
            const matchesTenant = tenantQuery === '' || rowTenant.toLowerCase().includes(tenantQuery);
            row.style.display = (matchesProp && matchesTenant) ? '' : 'none';
        });
    }

    propertySelect.addEventListener('change', applyFilters);
    tenantSearch.addEventListener('input', applyFilters);

    let selectedRow = null;
    function clearSelection() {
        if (!selectedRow) return;
        selectedRow.classList.remove('row-selected');
        selectedRow = null;
    }

    rows.forEach(row => {
        row.addEventListener('click', (e) => {
            if (e.target.closest('.indicator')) return;
            if (selectedRow) selectedRow.classList.remove('row-selected');
            selectedRow = row;
            selectedRow.classList.add('row-selected');
        });
    });

    const btnPaid = document.getElementById('btnPaid');
    const btnUnpaid = document.getElementById('btnUnpaid');

    function updatePaymentForRow(row, paid) {
        const paymentIndicator = row.querySelector('.payment-cell .indicator');
        if (!paymentIndicator) return;
        if (paid) {
            paymentIndicator.textContent = '+';
            paymentIndicator.classList.remove('bg-red-100', 'text-red-800');
            paymentIndicator.classList.add('bg-green-100', 'text-green-800');
            paymentIndicator.setAttribute('aria-label', 'Payment: yes');
        } else {
            paymentIndicator.textContent = '-';
            paymentIndicator.classList.remove('bg-green-100', 'text-green-800');
            paymentIndicator.classList.add('bg-red-100', 'text-red-800');
            paymentIndicator.setAttribute('aria-label', 'Payment: no');
        }
    }

    function togglePaymentStatus(paymentCell) {
        const paymentIndicator = paymentCell.querySelector('.indicator');
        if (!paymentIndicator) return;
        const isPaid = paymentIndicator.textContent === '+';
        updatePaymentForRow(paymentCell.closest('tr'), !isPaid);
        flashMessage(`Payment status ${!isPaid ? 'set to paid (+)' : 'set to unpaid (-)'}`, !isPaid ? 'green' : 'red');
    }

    document.querySelectorAll('.payment-cell').forEach(cell => {
        cell.addEventListener('click', function(e) {
            if (e.target.closest('.indicator')) {
                togglePaymentStatus(this);
            }
        });
    });

    function flashMessage(msg, color = 'yellow') {
        const el = document.createElement('div');
        el.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-sm font-medium ${
            color === 'green' ? 'bg-green-100 text-green-800' :
            color === 'red' ? 'bg-red-100 text-red-800' :
            'bg-yellow-100 text-yellow-800'
        }`;
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1600);
    }

    btnPaid.addEventListener('click', () => {
        if (!selectedRow) return flashMessage('No row selected — click a row first.', 'yellow');
        updatePaymentForRow(selectedRow, true);
        flashMessage('Payment set to + (paid).', 'green');
    });

    btnUnpaid.addEventListener('click', () => {
        if (!selectedRow) return flashMessage('No row selected — click a row first.', 'yellow');
        updatePaymentForRow(selectedRow, false);
        flashMessage('Payment set to - (unpaid).', 'red');
    });

    propertySelect.addEventListener('change', function () {
        const selectedValue = this.value;
        if (selectedValue && selectedValue !== 'all') {
            document.getElementById('propertyForm').submit();
        }
    });

    // Fixed Modal JS
    const paymentModal = document.getElementById('paymentModal');
    const modalUnitDisplay = document.getElementById('modalUnitDisplay');
    const modalOriginalRent = document.getElementById('modalOriginalRent');
    const modalUnit = document.getElementById('modalUnit');
    const modalId = document.getElementById('modalId');
    const modalRentInput = document.getElementById('modalRentInput');

    // Function to open payment modal with correct row data
    function openPaymentModal(unit, rent, id) {
        modalUnitDisplay.textContent = unit;
        modalOriginalRent.textContent = rent;
        modalUnit.value = unit;
        modalId.value = id;
        modalRentInput.value = rent; // Pre-fill with original rent amount
        modalRentInput.focus(); // Focus on the input field
        paymentModal.classList.remove('hidden');
        paymentModal.classList.add('flex');
    }

    // Function to close payment modal
    function closePaymentModal() {
        paymentModal.classList.add('hidden');
        paymentModal.classList.remove('flex');
    }

    // Add event listeners to all payment indicators
    document.addEventListener('DOMContentLoaded', function() {
        const openPayButtons = document.querySelectorAll('.open-pay');

        openPayButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const unit = this.dataset.unit;
                const rent = this.dataset.rent;
                const id = this.dataset.id;

                if (!unit || !rent || !id) {
                    // If data attributes are missing, try to get from the row
                    const row = this.closest('tr');
                    const unitCell = row.querySelector('.unit-number');
                    const rentCell = row.querySelector('.rent-amount');
                    const idCell = row.querySelector('.unit-id');

                    openPaymentModal(
                        unit || unitCell.textContent,
                        rent || rentCell.textContent,
                        id || idCell.textContent
                    );
                } else {
                    openPaymentModal(unit, rent, id);
                }
            });
        });
    });

    // Close modal when clicking outside
    paymentModal.addEventListener('click', function(e) {
        if (e.target === paymentModal) {
            closePaymentModal();
        }
    });

    // Handle form submission
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const unit = modalUnit.value;
        const rent = modalRentInput.value;
        const id = modalId.value;

        if (!rent || rent <= 0) {
            flashMessage('Please enter a valid rent amount', 'red');
            modalRentInput.focus();
            return;
        }

        // Show loading message
        flashMessage(`Updating payment for Unit ${unit}...`, 'yellow');

        // Submit the form to the backend
        this.submit();
    });

    applyFilters();
</script>
</body>
</html>