<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ProMan — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* CSS Variables for Light/Dark Themes */
        :root {
            /* Light Theme (Default) */
            --bg: #f5f6f7;
            --surface: #ffffff;
            --muted: #eef0f2;
            --text: #2f3337;
            --muted-text: #6b7378;
            --accent: #D4AF37;
            --accent-dark: #b8892a;
            --sidebar-bg: #f1f3f4;
            --card-bg: #ffffff;
            --table-header-bg: rgba(212,175,55,0.1);
            --table-row-even: rgba(212,175,55,0.02);
            --table-row-hover: rgba(212,175,55,0.05);
            --table-border: rgba(212,175,55,0.3);
            --modal-bg: #ffffff;
            --modal-text: #2f3337;
            --error-bg: #fef2f2;
            --error-text: #991b1b;
            --success-bg: #f0fdf4;
            --success-text: #166534;
        }

        body.dark {
            /* Dark Theme */
            --bg: #0f172a;
            --surface: #1e293b;
            --muted: #334155;
            --text: #f1f5f9;
            --muted-text: #94a3b8;
            --accent: #F4B342;
            --accent-dark: #E0A028;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --table-header-bg: rgba(244, 179, 66, 0.15);
            --table-row-even: rgba(244, 179, 66, 0.05);
            --table-row-hover: rgba(244, 179, 66, 0.1);
            --table-border: rgba(244, 179, 66, 0.3);
            --modal-bg: #1e293b;
            --modal-text: #f1f5f9;
            --error-bg: #450a0a;
            --error-text: #fca5a5;
            --success-bg: #052e16;
            --success-text: #86efac;
        }

        /* Base Styles */
        html,body { height:100%; }
        body {
            margin:0;
            min-height:100%;
            background:var(--bg);
            color:var(--text);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            flex-direction:column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header - Increased height */
        header.topbar {
            background: var(--surface);
            border-bottom: 1px solid var(--muted);
            position: sticky;
            top: 0;
            z-index: 60;
            height: 100px;
        }

        header .brand-left { display:flex; gap:1rem; align-items:center; }
        header .brand-left img { height:5rem; width:auto; }
        header .brand-left a.text-accent { color: var(--accent); font-weight:800; font-size:1.125rem; }

        .main-wrap {
            display:flex;
            flex:1;
            min-height: calc(100vh - 100px);
        }

        /* Sidebar */
        .sidebar {
            width:16rem;
            height: calc(100vh - 100px);
            position:fixed;
            left:0;
            top: 100px;
            z-index:50;
            overflow: hidden;
            background: var(--sidebar-bg);
            transition: transform .28s ease, box-shadow .28s ease, background-color 0.3s ease;
            border-right: 1px solid var(--muted);
            transform: translateX(0);
            display: flex;
            flex-direction: column;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Desktop layout */
        @media (min-width:1025px) {
            .content {
                margin-left: 16rem;
                padding:1.5rem;
                padding-top:2rem;
                width: calc(100% - 16rem);
            }
            #sidebar-backdrop { display:none; }
            #mobile-menu-button { display:none; }
        }

        /* Mobile overlay behavior */
        @media (max-width:1024px) {
            .sidebar {
                transform: translateX(-100%);
                position:fixed;
                height: calc(100vh - 100px);
                left:0;
                top: 100px;
                box-shadow: 0 18px 40px rgba(16,24,40,0.12);
            }
            body.dark .sidebar {
                box-shadow: 0 18px 40px rgba(0,0,0,0.4);
            }
            .sidebar.overlay-visible {
                transform: translateX(0);
                background: var(--sidebar-bg);
            }
            .content {
                margin-left: 0;
                padding:1rem;
                padding-top:1.5rem;
                width: 100%;
            }
            #sidebar-backdrop {
                display:block;
                position:fixed;
                inset:0;
                background:rgba(0,0,0,0.45);
                z-index:45;
                opacity:0;
                pointer-events:none;
                transition:opacity .18s ease;
            }
            #sidebar-backdrop.visible {
                opacity:1;
                pointer-events:auto;
            }
            #mobile-menu-button {
                display: flex;
            }
        }

        .sidebar .card {
            background: linear-gradient(180deg, var(--surface), var(--surface));
            border:1px solid var(--muted);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-left: 3px solid rgba(212,175,55,0.18);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        body.dark .sidebar .card {
            border-left: 3px solid rgba(244, 179, 66, 0.18);
        }

        /* WIGGLE EFFECT for sidebar stats cards */
        .sidebar-stats .card {
            animation: none;
        }

        .sidebar-stats .card:hover {
            animation: wiggle 0.5s ease-in-out;
            transform-origin: center center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body.dark .sidebar-stats .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-1.5deg); }
            50% { transform: rotate(1.5deg); }
            75% { transform: rotate(-1deg); }
        }

        /* Bounce effect alternative (comment out wiggle and uncomment this for bounce) */
        /*
        .sidebar-stats .card:hover {
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        */

        .feature-icon {
            width:44px;
            height:44px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            border-radius:8px;
            background: rgba(212,175,55,0.08);
            color: var(--accent);
            transition: transform 0.3s ease;
        }

        .sidebar-stats .card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
        }

        body.dark .feature-icon {
            background: rgba(244, 179, 66, 0.08);
        }

        .nav-item {
            display:flex;
            align-items:center;
            gap:.75rem;
            padding:.75rem;
            border-radius:.5rem;
            color: var(--text);
            text-decoration:none;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.05);
        }

        body.dark .nav-item {
            background: rgba(255,255,255,0.05);
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            /* No wiggle for nav items */
            transform: none !important;
            animation: none !important;
        }

        body.dark .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(212,175,55,0.1);
            border-left: 4px solid var(--accent);
            color: var(--text);
            box-shadow: 0 2px 6px rgba(212,175,55,0.1);
        }

        body.dark .nav-item.active {
            background: rgba(244, 179, 66, 0.1);
            box-shadow: 0 2px 6px rgba(244, 179, 66, 0.1);
        }

        .card-surface {
            background: var(--surface);
            border-radius:.75rem;
            box-shadow: 0 18px 40px rgba(16,24,40,0.06);
            padding:1.25rem;
            border:1px solid var(--muted);
            transition: all 0.3s ease;
        }

        body.dark .card-surface {
            box-shadow: 0 18px 40px rgba(0,0,0,0.2);
        }

        /* TABLE Styles */
        .units-wrapper {
            width:100%;
            overflow-x:auto;
            -webkit-overflow-scrolling:touch;
            max-width: 100%;
        }

        .units-table {
            width:100%;
            min-width:760px;
            border-collapse:separate;
            border-spacing:0;
            border-radius:.5rem;
            overflow:hidden;
            box-shadow: 0 8px 24px rgba(16,24,40,0.04);
        }

        body.dark .units-table {
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .units-table thead th {
            background: var(--table-header-bg);
            color:var(--text);
            font-weight:700;
            padding:.75rem 1rem;
            text-align:left;
            border-bottom: 1px solid var(--table-border);
            position:sticky;
            top:0;
            z-index:10;
        }

        .units-table tbody td {
            background: var(--surface);
            padding:.75rem 1rem;
            border-bottom:1px solid var(--muted);
            color:var(--text);
            white-space:nowrap;
        }

        .units-table tbody tr:hover td {
            background: var(--table-row-hover);
        }

        .units-table tbody tr:nth-child(even) td {
            background: var(--table-row-even);
        }

        .indicator {
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width:1.9rem;
            height:1.9rem;
            border-radius:.5rem;
            font-weight:700;
        }

        .indicator.bg-red-100, .indicator.bg-red {
            background: rgba(255,69,58,0.08);
            color:#C53030;
        }

        body.dark .indicator.bg-red-100, body.dark .indicator.bg-red {
            background: rgba(239,68,68,0.15);
            color:#fca5a5;
        }

        .indicator.bg-green-100, .indicator.bg-green {
            background: rgba(16,185,129,0.08);
            color:#065f46;
        }

        body.dark .indicator.bg-green-100, body.dark .indicator.bg-green {
            background: rgba(34,197,94,0.15);
            color:#86efac;
        }

        .control-btn { padding:.65rem .85rem; border-radius:.5rem; font-weight:600; }

        /* Row selection styling */
        .row-selected {
            background-color: rgba(212,175,55,0.1) !important;
            outline: 2px solid var(--accent);
        }

        body.dark .row-selected {
            background-color: rgba(244, 179, 66, 0.1) !important;
        }

        .content {
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Mobile table adjustments */
        @media (max-width: 768px) {
            .units-table {
                min-width: 600px;
            }
            .flex-col-mobile {
                flex-direction: column;
            }
            .w-full-mobile {
                width: 100%;
            }
        }

        /* Sidebar header styling */
        .sidebar-header {
            background: var(--sidebar-bg);
            padding: 1.5rem;
            border-bottom: 1px solid var(--muted);
            text-align: center;
        }

        /* Enhanced table styling */
        .tenant-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-placeholder {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-text);
        }

        .tenant-details {
            display: flex;
            flex-direction: column;
        }

        .tenant-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .tenant-contact {
            font-size: 12px;
            color: var(--muted-text);
        }

        .unit-details {
            display: flex;
            flex-direction: column;
        }

        .unit-number {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .unit-rent {
            font-size: 12px;
            color: var(--muted-text);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background-color: rgba(16,185,129,0.1);
            color: #065f46;
        }

        body.dark .status-active {
            background-color: rgba(34,197,94,0.15);
            color: #86efac;
        }

        .status-pending {
            background-color: rgba(245,158,11,0.1);
            color: #92400e;
        }

        body.dark .status-pending {
            background-color: rgba(245,158,11,0.15);
            color: #fcd34d;
        }

        .status-vacant {
            background-color: rgba(239,68,68,0.1);
            color: #991b1b;
        }

        body.dark .status-vacant {
            background-color: rgba(239,68,68,0.15);
            color: #fca5a5;
        }

        .edit-btn {
            background: transparent;
            border: none;
            color: #3b82f6;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
        }

        body.dark .edit-btn {
            color: #60a5fa;
        }

        .edit-btn:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        body.dark .edit-btn:hover {
            background-color: rgba(96, 165, 250, 0.1);
        }

        /* Header with date display */
        .header-with-date {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .date-display {
            background: var(--surface);
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-right: 4px solid var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-top: 0.5rem;
        }

        body.dark .date-display {
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .header-with-date {
                flex-direction: column;
                gap: 1rem;
            }
            .date-display {
                align-self: flex-end;
            }
        }

        /* Fix for Monthly Revenue card position */
        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Payment Modal Styling */
        #paymentModal {
            z-index: 1000;
        }

        .modal-card {
            z-index: 1001;
            position: relative;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* View modes */
        .property-form-container {
            transition: all 0.3s ease;
        }

        .property-form-container.hidden {
            display: none;
        }

        .property-name-display {
            background: linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.06));
            border: 1.5px solid rgba(212,175,55,0.3);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            box-shadow: 0 4px 12px rgba(212,175,55,0.08);
            transition: all 0.3s ease;
        }

        body.dark .property-name-display {
            background: linear-gradient(135deg, rgba(244, 179, 66, 0.12), rgba(244, 179, 66, 0.06));
            border: 1.5px solid rgba(244, 179, 66, 0.3);
            box-shadow: 0 4px 12px rgba(244, 179, 66, 0.08);
        }

        .property-name-display:hover {
            box-shadow: 0 6px 16px rgba(212,175,55,0.12);
            border-color: rgba(212,175,55,0.4);
            transform: translateY(-2px);
        }

        body.dark .property-name-display:hover {
            box-shadow: 0 6px 16px rgba(244, 179, 66, 0.12);
            border-color: rgba(244, 179, 66, 0.4);
        }

        .property-name-display svg {
            color: var(--accent);
            flex-shrink: 0;
            stroke-width: 1.8;
        }

        .property-name-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            flex-grow: 1;
            letter-spacing: -0.3px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .property-badge {
            background: var(--accent);
            color: #2b1f00;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(212,175,55,0.3);
        }

        body.dark .property-badge {
            color: #1a1400;
            box-shadow: 0 2px 4px rgba(244, 179, 66, 0.3);
        }

        .full-table-view .lg\:w-2\/3 {
            width: 100% !important;
        }

        .change-property-btn {
            display: none;
        }

        .full-table-view .change-property-btn {
            display: block;
            margin: 0 auto 1rem auto;
        }

        .view-table-btn {
            margin-top: 1rem;
        }

        /* Modal styling */
        #paymentModal .bg-white {
            background: var(--modal-bg) !important;
            color: var(--modal-text);
        }

        #paymentModal .text-gray-700 {
            color: var(--modal-text);
        }

        #paymentModal input {
            background: var(--surface) !important;
            color: var(--text);
            border: 1px solid var(--muted);
        }

        #paymentModal input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(212,175,55,0.1);
        }

        body.dark #paymentModal input:focus {
            box-shadow: 0 0 0 4px rgba(244, 179, 66, 0.15);
        }

        /* Dark mode toggle button */
        #dark-mode-toggle {
            transition: all 0.3s ease;
            background: var(--muted);
            color: var(--text);
            border: 1px solid var(--muted);
        }

        #dark-mode-toggle:hover {
            background: var(--accent);
            color: #2b1f00;
            transform: rotate(30deg);
        }

        body.dark #dark-mode-toggle:hover {
            color: #1a1400;
        }

        /* Error/Success messages */
        .text-green-600 {
            color: var(--success-text) !important;
        }

        #paymentErrorDisplay {
            background: var(--error-bg) !important;
            color: var(--error-text) !important;
            border-color: var(--error-text) !important;
        }

        /* Form elements */
        select, input {
            background: var(--surface) !important;
            color: var(--text);
            border: 1px solid var(--muted);
        }

        select:focus, input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(212,175,55,0.1);
        }

        body.dark select:focus, body.dark input:focus {
            box-shadow: 0 0 0 4px rgba(244, 179, 66, 0.15);
        }

        /* Header adjustments for larger logo */
        header.topbar {
            height: 150px;
        }

        header .max-w-6xl.mx-auto.px-6 {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header .brand-left {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            height: 100%;
        }

        header .brand-left a {
            display: flex;
            align-items: center;
            height: 100%;
            min-height: 120px;
        }

        header .brand-left img {
            height: auto;
            max-height: 120px;
            width: auto;
        }

        .main-wrap {
            min-height: calc(100vh - 150px);
        }

        .sidebar {
            height: calc(100vh - 150px);
            top: 150px;
        }

        @media (max-width:1024px) {
            .sidebar {
                height: calc(100vh - 150px);
                top: 150px;
            }
        }

        /* Mobile-specific improvements for sidebar */
        @media (max-width: 768px) {
            .sidebar-content {
                padding: 0.75rem;
            }

            .nav-item {
                padding: 0.5rem;
                font-size: 14px;
            }

            .property-name-display {
                padding: 10px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .property-name-text {
                font-size: 16px;
            }

            .sidebar-stats {
                gap: 0.5rem;
            }

            .card {
                padding: 12px;
            }

            .feature-icon {
                width: 36px;
                height: 36px;
            }
        }

        /* Highlighted payment column - ADDED THIS */
        .units-table th:nth-child(6),
        .units-table td:nth-child(6) {
            background: rgba(212,175,55,0.15) !important;
            position: relative;
        }

        body.dark .units-table th:nth-child(6),
        body.dark .units-table td:nth-child(6) {
            background: rgba(244,179,66,0.2) !important;
        }

        .units-table th:nth-child(6)::after,
        .units-table td:nth-child(6)::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent);
            opacity: 0.6;
        }

        .units-table td:nth-child(6):hover {
            background: rgba(212,175,55,0.25) !important;
        }

        body.dark .units-table td:nth-child(6):hover {
            background: rgba(244,179,66,0.3) !important;
        }

        .payment-cell {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-cell:hover .indicator {
            transform: scale(1.1);
        }

        @media (max-width: 640px) {
            .payment-cell .indicator {
                width: 2.2rem;
                height: 2.2rem;
                font-size: 1.2rem;
            }
        }

        /* Mobile Menu Button Styles */
        #mobile-menu-button {
            display: none;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--surface);
            border: 1px solid var(--muted);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 70;
        }

        #mobile-menu-button:hover {
            background: var(--muted);
            transform: translateY(-1px);
        }

        #mobile-menu-button:active {
            transform: translateY(0);
        }

        .mobile-menu-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }

        .mobile-menu-icon span {
            display: block;
            height: 2px;
            width: 100%;
            background: var(--text);
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        #mobile-menu-button[aria-expanded="true"] .mobile-menu-icon span:nth-child(1) {
            transform: rotate(45deg) translate(4px, 4px);
        }

        #mobile-menu-button[aria-expanded="true"] .mobile-menu-icon span:nth-child(2) {
            opacity: 0;
        }

        #mobile-menu-button[aria-expanded="true"] .mobile-menu-icon span:nth-child(3) {
            transform: rotate(-45deg) translate(4px, -4px);
        }

        body.dark #mobile-menu-button .mobile-menu-icon span {
            background: var(--text);
        }

        /* Header actions container */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Theme toggle button in header */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--surface);
            border: 1px solid var(--muted);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--muted);
            transform: rotate(15deg);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 1024px) {
            #mobile-menu-button {
                display: flex;
            }

            .theme-toggle {
                width: 44px;
                height: 44px;
            }
        }

        /* PULSE effect for sidebar stats - alternative to wiggle */
        .sidebar-stats .card.pulse-effect:hover {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* SHAKE effect for sidebar stats - another alternative */
        .sidebar-stats .card.shake-effect:hover {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            50% { transform: translateX(2px); }
            75% { transform: translateX(-1px); }
        }
    </style>
</head>

<body class="antialiased" th:classappend="${user_chosen_theme == 'dark'} ? 'dark' : ''">
<!-- Store Thymeleaf variable in JavaScript -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const serverTheme = /*[[${user_chosen_theme}]]*/ 'light';
    console.log("Server theme from Thymeleaf:", serverTheme);
    /*]]>*/
</script>

<header class="topbar">
    <div class="max-w-6xl mx-auto px-6 py-8 flex items-center justify-between h-full">
        <div class="brand-left flex items-center gap-6">
            <div class="flex items-center justify-center h-32 w-auto">
                <img src="/umuzi/img/mypromann.png" alt="ProMan logo"
                     class="h-32 md:h-40 lg:h-48 w-auto object-contain"
                     style="height: 128px; max-height: 192px;">
            </div>
            <div class="flex flex-col">
                <span class="text-accent font-extrabold text-2xl">ProMan</span>
                <div class="text-sm" style="color:var(--muted-text); margin-top:-2px;">Property management simplified</div>
            </div>
        </div>

        <!-- Header Actions (Mobile Menu & Theme Toggle) -->
        <div class="header-actions">
            <!-- Dark Mode Toggle -->
            <button id="dark-mode-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>

            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" aria-label="Open navigation menu" aria-expanded="false" aria-controls="sidebar">
                <div class="mobile-menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>
    </div>
</header>

<div id="sidebar-backdrop"></div>
<div class="main-wrap">
    <aside id="sidebar" class="sidebar" role="navigation" aria-label="Main sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <!-- Property name made to stand out -->
                <div class="property-name-display">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="property-name-text" th:text="${name}">Property Name</span>
                    <span class="property-badge">ACTIVE</span>
                </div>
            </div>
            <nav class="mb-4 space-y-2">
                <a href="http://localhost:7070/add_property_unit " class="nav-item active">ADD PROPERTY</a>
                <a href="http://localhost:7070/add_tenant" class="nav-item active">ADD UNITS</a>
            </nav>
            <div class="sidebar-stats">
                <div class="card rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm" style="color:var(--muted-text)">Total Properties</p>
                            <p class="text-lg font-bold" style="color:var(--text)" th:text="${total_properties}">8</p>
                        </div>
                        <div class="feature-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10"/></svg>
                        </div>
                    </div>
                </div>

                <div class="card rounded-lg p-3" style="border-left-color: rgba(34,197,94,0.18);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm" style="color:var(--muted-text)">Occupied Units</p>
                            <p class="text-lg font-bold" style="color:var(--text)" th:text="${occupied_units}">0</p>
                        </div>
                        <div class="feature-icon" style="background: rgba(255,255,255,0.06); color:var(--text)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4"/></svg>
                        </div>
                    </div>
                    <p class="text-sm"
                       style="color:var(--muted-text); margin-top:6px"
                       th:text="${occupancyRate + '% occupancy rate'}">
                        0% occupancy rate
                    </p>
                </div>

                <div class="card rounded-lg p-3" style="border-left-color: rgba(59,130,246,0.18);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm" style="color:var(--muted-text)">Vacant Units</p>
                            <p class="text-lg font-bold" style="color:var(--text)"  th:text="${vacant}">2</p>
                        </div>
                        <div class="feature-icon" style="background: rgba(255,255,255,0.06); color:var(--text)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 12H4"/></svg>
                        </div>
                    </div>
                    <p class="text-sm" style="color:var(--muted-text); margin-top:6px">Available for rent</p>
                </div>

                <div class="card rounded-lg p-3" style="border-left-color: rgba(139,92,60,0.18);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm" style="color:var(--muted-text)">Monthly Revenue</p>
                            <p class="text-lg font-bold" style="color:var(--text)" th:text="'R' + ${expected_profit}">R0</p>
                        </div>
                        <div class="feature-icon" style="background: rgba(255,255,255,0.06); color:var(--text)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2"/></svg>
                        </div>
                    </div>
                    <p class="text-sm" style="color:var(--muted-text); margin-top:6px">+R2,500 from last month</p>
                </div>
            </div>

            <div class="mt-auto pt-6">
                <a href="http://localhost:7070/logout"
                   class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-bold shadow-lg hover:from-yellow-600 hover:to-yellow-700 transition-all duration-200 transform hover:scale-[1.02] active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sign Out
                </a>
            </div>
        </div>

    </aside>
    <main class="content">
        <div class="p-6">
            <!-- Updated header with date display on the right -->
            <div class="header-with-date">
                <div>
                    <h1 class="text-3xl font-bold" style="color:var(--accent)">Property Management</h1>
                    <p class="text-[var(--muted-text)]">Manage your properties and tenant payments</p>
                </div>

                <!-- Date display div with gold right border -->
                <div class="date-display">
                    <span class="text-lg font-medium" id="currentDate"></span>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6" id="mainContent">
                <!-- Property Selection Section -->
                <div class="lg:w-1/3 property-form-container" id="propertyFormContainer">
                    <div class="card-surface h-full">
                        <form id="propertyForm" action="http://localhost:7070/fetch_property_units" method="post">
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-[var(--muted-text)] mb-2">Property Name</label>
                                    <p  th:text="${name}"></p>
                                    <select id="propertySelect" name="name" class="w-full rounded-md border-gray-300 shadow-sm focus:ring-0 focus:border-[var(--accent)]">
                                        <option value="">Select property</option>
                                        <option th:each="name : ${names}" th:value="${name}" th:text="${name}">Default Name</option>
                                    </select>
                                </div>
                            </div>
                        </form>

                        <div class="mt-6">
                            <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center h-48">
                                <img src="/umuzi/img/mypromann.png" alt="ProMan logo"
                                     class="h-28 md:h-32 lg:h-36 w-auto object-contain">
                            </div>
                        </div>
                        <!-- REMOVED: View Full Table button from here -->
                    </div>
                </div>

                <!-- Table Section -->
                <div class="lg:w-2/3" id="tableContainer">
                    <div class="card-surface h-full">
                        <!-- ADDED: View Units Table button (replaces Change Property button) -->
                        <button id="viewTableBtn" class="change-property-btn w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-[var(--accent)] text-[var(--text)] rounded-lg hover:bg-[var(--accent-dark)] transition font-medium mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            View Units Table
                        </button>

                        <div id="controlsWrapper" class="mb-4 flex flex-wrap gap-3 items-center">
                            <div class="text-sm" style="color:var(--text)">
                                Click the payment column to mark a tenant as paid.
                            </div>
                        </div>

                        <div id="paymentErrorDisplay" class="hidden p-3 mb-4 rounded-md text-sm font-medium bg-red-100 text-red-800 border border-red-300" role="alert">
                        </div>
                        <p th:if="${unit != null and unit != ''}"
                           th:text="|You have already marked Unit ${unit} as paid this month.|" class="text-green-600 font-medium"></p>
                        <p th:if="${success != null and success != ''}"
                           th:text="|Unit ${success} marked as paid this month.|" class="text-green-600 font-medium"></p>
                        <div class="units-wrapper w-full overflow-x-auto">
                            <table class="units-table min-w-max w-full border-collapse">
                                <thead>
                                <tr>
                                    <th class="px-4 py-3 whitespace-nowrap">Tenant</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Unit Details</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Status</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Rent Day</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Overdue</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Payment</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="unitsTbody">
                                <!-- Show units when they exist -->
                                <tr th:each="entry : ${units}" class="hover:cursor-pointer">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="tenant-info">
                                            <div class="profile-placeholder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="12" cy="7" r="4"></circle>
                                                </svg>
                                            </div>
                                            <div class="tenant-details">
                                                <div class="tenant-name" th:text="${entry.value[3]}">Tenant Name</div>
                                                <div class="tenant-contact">Contact info</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="unit-details">
                                            <div class="unit-number" th:text="${entry.value[0]}">Unit Number</div>
                                            <div class="unit-rent" th:text="'R ' + ${entry.value[1]}">Rent Amount</div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span th:if="${entry.value[2]} == 'yes'" class="status-badge status-active">Occupied</span>
                                        <span th:if="${entry.value[2]} == 'no'" class="status-badge status-vacant">Vacant</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap unit-tenant" th:text="${entry.value[4]}">Rent Day</td>
                                    <td class="px-4 py-3 whitespace-nowrap unit-tenant" th:text="${entry.value[5]}">Overdue Days</td>
                                    <td class="px-4 py-3 whitespace-nowrap payment-cell">
                <span th:if="${entry.value[2]} == 'yes'"
                      th:with="isPaid=${entry.value[6]}"
                      th:classappend="${isPaid} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                      class="indicator open-pay cursor-pointer"
                      th:data-unit="${entry.value[0]}" th:data-rent="${entry.value[1]}"
                      th:data-id="${entry.value[3]}" th:data-property-name="${propertyName}"
                      th:text="${isPaid} ? '+' : '−'">−</span>
                                        <span th:if="${entry.value[2]} == 'no'" class="indicator bg-red-100 text-red-800">−</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <button class="edit-btn">Edit</button>
                                    </td>
                                </tr>

                                <!-- Show "No Units" message when empty -->
                                <tr th:if="${units == null or units.isEmpty()}" class="no-units-row">
                                    <td colspan="7" class="px-4 py-8">
                                        <div class="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg border border-gray-200">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                            </svg>
                                            <h3 class="text-lg font-medium text-gray-700 mb-2">No Units Found</h3>
                                            <p class="text-gray-500 mb-4 max-w-md text-center">
                                                You don't have any units added yet. Get started by adding your first unit and tenant.
                                            </p>
                                            <a href="http://localhost:7070/add_tenant" class="inline-flex items-center gap-2 px-4 py-2 bg-[var(--accent)] text-[var(--text)] rounded-lg hover:bg-[var(--accent-dark)] transition font-medium">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                                </svg>
                                                Add New Unit
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<p th:text="${default_name}"></p>

<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-[1000]">
    <div class="modal-card w-96 text-center z-[1001]">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-3">Update Payment Status</h2>
            <p class="text-gray-700 mb-2">Unit: <span id="modalUnitDisplay" class="font-bold"></span></p>
            <p class="text-gray-700 mb-4 text-sm">Original Rent: <span id="modalOriginalRent" class="font-bold"></span></p>
            <form id="paymentForm" method="post">
                <input type="hidden" name="action_type" id="modalAction">
                <input type="hidden" name="unit" id="modalUnit">
                <input type="hidden" name="id" id="modalId">
                <input type="hidden" name="property_name" id="modalPropertyName">
                <input type="hidden" name="paid" value="yes">
                <div class="mb-4 text-left">
                    <label for="modalRentInput" class="block text-sm font-medium text-[var(--muted-text)] mb-2">Rent Paid Amount:</label>
                    <input type="number" id="modalRentInput" name="rent" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent" placeholder="Enter rent amount">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition">Confirm Payment</button>
                    <button type="button" onclick="closePaymentModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // =========================================================================
    // DARK MODE FUNCTIONS WITH AJAX (Option 2)
    // =========================================================================

    // AJAX function to send theme preference without page reload
    async function sendThemePreference(theme) {
        try {
            const response = await fetch('http://localhost:7070/page_theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `user_theme=${theme}`
            });

            // Don't reload the page, just update local storage
            localStorage.setItem('user_chosen_theme', theme);

            console.log('Theme preference saved:', theme);

        } catch (error) {
            console.error('Error sending theme preference:', error);
            // Fallback: still update local storage even if server request fails
            localStorage.setItem('user_chosen_theme', theme);
        }
    }

    function initializeIcons() {
        const isDark = document.body.classList.contains('dark');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        if (sunIcon && moonIcon) {
            if (isDark) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }
    }

    async function toggleDarkMode() {
        const isCurrentlyDark = document.body.classList.contains('dark');
        const newTheme = isCurrentlyDark ? 'light' : 'dark';

        if (isCurrentlyDark) {
            document.body.classList.remove('dark');
        } else {
            document.body.classList.add('dark');
        }

        initializeIcons();

        // Send preference without page reload using AJAX
        await sendThemePreference(newTheme);
    }

    // =========================================================================
    // GLOBAL FUNCTIONS (Accessible to onclick handlers)
    // =========================================================================

    function closePaymentModal() {
        const paymentModal = document.getElementById('paymentModal');
        if (!paymentModal) return;
        paymentModal.classList.add('hidden');
        paymentModal.classList.remove('flex');
        document.body.classList.remove('modal-open');
    }

    function displayErrorBanner(message, isClear = false) {
        const errorDisplay = document.getElementById('paymentErrorDisplay');
        if (!errorDisplay) return;

        if (isClear || !message) {
            errorDisplay.classList.add('hidden');
            errorDisplay.textContent = '';
        } else {
            errorDisplay.textContent = message;
            errorDisplay.classList.remove('hidden');
        }
    }

    // Mobile menu functions
    function openMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        const mobileMenuButton = document.getElementById('mobile-menu-button');

        if (sidebar) sidebar.classList.add('overlay-visible');
        if (backdrop) backdrop.classList.add('visible');
        if (mobileMenuButton) mobileMenuButton.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        const mobileMenuButton = document.getElementById('mobile-menu-button');

        if (sidebar) sidebar.classList.remove('overlay-visible');
        if (backdrop) backdrop.classList.remove('visible');
        if (mobileMenuButton) mobileMenuButton.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
    }

    function toggleMobileMenu() {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';

        if (isExpanded) {
            closeMobileMenu();
        } else {
            openMobileMenu();
        }
    }

    // =========================================================================
    // DOMContentLoaded Event Listener
    // =========================================================================

    document.addEventListener('DOMContentLoaded', function() {
        // Use server theme as primary source
        const serverTheme = window.serverTheme || 'light';
        localStorage.setItem('user_chosen_theme', serverTheme);
        initializeIcons();

        // Add event listener to dark mode toggle button
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', async function(event) {
                event.preventDefault();
                event.stopPropagation();
                await toggleDarkMode();
            });
        }

        // Mobile menu button functionality
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', toggleMobileMenu);
        }

        // Close mobile menu when clicking backdrop
        const backdrop = document.getElementById('sidebar-backdrop');
        if (backdrop) {
            backdrop.addEventListener('click', closeMobileMenu);
        }

        // Close mobile menu when clicking on sidebar links
        const sidebarLinks = document.querySelectorAll('.sidebar a');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', closeMobileMenu);
        });

        // Close mobile menu on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        // Close mobile menu on window resize above 1024px
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                closeMobileMenu();
            }
        });

        // View Units Table button functionality (toggles property selection panel)
        const viewTableBtn = document.getElementById('viewTableBtn');
        const changePropertyBtn = document.getElementById('changePropertyBtn');
        const propertyFormContainer = document.getElementById('propertyFormContainer');
        const tableContainer = document.getElementById('tableContainer');
        const mainContent = document.getElementById('mainContent');

        if (viewTableBtn && propertyFormContainer && tableContainer && mainContent) {
            viewTableBtn.addEventListener('click', function() {
                // Toggle property form visibility
                propertyFormContainer.classList.toggle('hidden');

                // Toggle button text based on state
                if (propertyFormContainer.classList.contains('hidden')) {
                    viewTableBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Show Property Selection
                    `;
                    mainContent.classList.add('full-table-view');
                } else {
                    viewTableBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        View Units Table
                    `;
                    mainContent.classList.remove('full-table-view');
                }
            });
        }

        // Format and display the current date
        function formatDate() {
            const date = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = formattedDate;
        }
        formatDate();

        // Auto-submit functionality for property form
        const propertySelect = document.getElementById('propertySelect');
        const propertyForm = document.getElementById('propertyForm');
        let autoSubmitted = false;

        if (propertySelect && propertyForm) {
            const selectedValue = propertySelect.value;
            if (selectedValue && selectedValue !== '' && selectedValue !== 'all' && !autoSubmitted) {
                autoSubmitted = true;
                propertyForm.submit();
            }

            propertySelect.addEventListener('change', function() {
                const newValue = this.value;
                if (newValue && newValue !== '' && newValue !== 'all') {
                    propertyForm.submit();
                }
            });
        }

        // =========================================================================
        // II. GLOBAL VARIABLE SETUP
        // =========================================================================
        const tbody = document.getElementById('unitsTbody');
        const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

        const paymentModal = document.getElementById('paymentModal');
        const modalUnitDisplay = document.getElementById('modalUnitDisplay');
        const modalOriginalRent = document.getElementById('modalOriginalRent');
        const modalUnit = document.getElementById('modalUnit');
        const modalId = document.getElementById('modalId');
        const modalPropertyName = document.getElementById('modalPropertyName');
        const modalRentInput = document.getElementById('modalRentInput');
        const paymentForm = document.getElementById('paymentForm');

        const errorDisplay = document.getElementById('paymentErrorDisplay');
        const confirmButton = document.querySelector('#paymentForm button[type="submit"]');

        const modalTitle = document.querySelector('#paymentModal h2');
        const modalSubmitButton = document.querySelector('#paymentForm button[type="submit"]');
        const paidInput = document.querySelector('#paymentForm input[name="paid"]');
        const modalAction = document.getElementById('modalAction');

        // =========================================================================
        // III. LOCAL UTILITY FUNCTIONS (Keep these inside)
        // =========================================================================

        function flashMessage(msg, color = 'yellow') {
            const el = document.createElement('div');
            el.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-sm font-medium ${
                color === 'green' ? 'bg-green-100 text-green-800' :
                color === 'red' ? 'bg-red-100 text-red-800' :
                'bg-yellow-100 text-yellow-800'
            }`;
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1600);
        }

        function ensureSidebarDesktop() {
          if (!sidebar) return;
          if (window.innerWidth > 1024) {
            sidebar.classList.remove('overlay-visible');
            if (backdrop) backdrop.classList.remove('visible');
            sidebar.style.transform = 'translateX(0)';
          } else {
            sidebar.style.transform = '';
            sidebar.classList.remove('overlay-visible');
            if (backdrop) backdrop.classList.remove('visible');
          }
        }

        function applyFilters() {
          const prop = propertySelect ? propertySelect.value : '';
          rows.forEach(row => {
            const rowProp = row.dataset.property || '';
            const matchesProp = (prop === 'all') || (rowProp === prop) || !prop;
            row.style.display = matchesProp ? '' : 'none';
          });
        }

        function updatePaymentForRow(row, paid) {
          const paymentIndicator = row.querySelector('.payment-cell .indicator');
          if (!paymentIndicator) return;
          if (paid) {
            paymentIndicator.textContent = '+';
            paymentIndicator.classList.remove('bg-red-100', 'text-red-800');
            paymentIndicator.classList.add('bg-green-100', 'text-green-800');
            paymentIndicator.setAttribute('aria-label', 'Payment: yes');
          } else {
            paymentIndicator.textContent = '-';
            paymentIndicator.classList.remove('bg-green-100', 'text-green-800');
            paymentIndicator.classList.add('bg-red-100', 'text-red-800');
            paymentIndicator.setAttribute('aria-label', 'Payment: no');
          }
        }

        function openPaymentModal(unit, rent, id, propertyName) {
            displayErrorBanner(null, true);

            if (modalTitle) modalTitle.textContent = "Record New Payment";
            if (modalSubmitButton) {
                modalSubmitButton.textContent = "Confirm Payment";
                modalSubmitButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                modalSubmitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }

            if (modalUnit) modalUnit.value = unit;
            if (modalId) modalId.value = id;
            if (modalPropertyName) modalPropertyName.value = propertyName;

            if (modalRentInput) {
                modalRentInput.value = rent.replace('R ', '').replace(/,/g, '');
                modalRentInput.disabled = false;
            }
            if (modalUnitDisplay) modalUnitDisplay.textContent = unit;
            if (modalOriginalRent) modalOriginalRent.textContent = rent;

            if (modalAction) modalAction.value = 'mark';
            if (paidInput) paidInput.value = 'yes';

            if (paymentModal) {
                paymentModal.classList.remove('hidden');
                paymentModal.classList.add('flex');
                document.body.classList.add('modal-open');
            }
        }

        function openUnmarkModal(unit, id, propertyName, rent) {
            displayErrorBanner(null, true);

            if (modalTitle) modalTitle.textContent = "Confirm Payment Removal";
            if (modalSubmitButton) {
                modalSubmitButton.textContent = "Unmark Payment";
                modalSubmitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                modalSubmitButton.classList.add('bg-red-600', 'hover:bg-red-700');
            }

            if (modalUnit) modalUnit.value = unit;
            if (modalId) modalId.value = id;
            if (modalPropertyName) modalPropertyName.value = propertyName;

            if (modalRentInput) {
                modalRentInput.value = rent.replace('R ', '').replace(/,/g, '');
                modalRentInput.disabled = true;
            }
            if (modalUnitDisplay) modalUnitDisplay.textContent = unit;
            if (modalOriginalRent) modalOriginalRent.textContent = rent;

            if (modalAction) modalAction.value = 'unmark';
            if (paidInput) paidInput.value = 'no';

            if (paymentModal) {
                paymentModal.classList.remove('hidden');
                paymentModal.classList.add('flex');
                document.body.classList.add('modal-open');
            }
        }

        // =========================================================================
        // IV. ASYNCHRONOUS PAYMENT SUBMISSION HANDLER
        // =========================================================================


if (paymentForm && confirmButton) {
    paymentForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        displayErrorBanner(null, true);

        confirmButton.disabled = true;
        confirmButton.textContent = 'Processing...';

        const formData = new FormData(paymentForm);
        const tenantName = formData.get('id');
        const unit = formData.get('unit');
        const actionType = formData.get('action_type');

        let url = "";

        if (actionType === 'unmark') {
            url = `http://localhost:7070/unmark_payment/${tenantName}/${unit}`;
        } else {
            url = `http://localhost:7070/payment_status/${tenantName}/${unit}`;
        }

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams(formData)
            });

            if (!response.ok) {
                const errorMessage = await response.text();
                displayErrorBanner(errorMessage || "Something went wrong.");
                confirmButton.disabled = false;
                confirmButton.textContent = actionType === 'unmark'
                    ? "Unmark Payment"
                    : "Confirm Payment";
                return;
            }

            // SUCCESS
            const rowIndicator = document.querySelector(
                `.indicator[data-unit="${unit}"][data-id="${tenantName}"]`
            );

            if (rowIndicator) {
                if (actionType === 'unmark') {
                    rowIndicator.textContent = "−";
                    rowIndicator.classList.remove("bg-green-100", "text-green-800");
                    rowIndicator.classList.add("bg-red-100", "text-red-800");
                } else {
                    rowIndicator.textContent = "+";
                    rowIndicator.classList.remove("bg-red-100", "text-red-800");
                    rowIndicator.classList.add("bg-green-100", "text-green-800");
                }
            }

            flashMessage(
                actionType === 'unmark'
                    ? `Payment removed for Unit ${unit}.`
                    : `Payment recorded for Unit ${unit}.`,
                "green"
            );

            closePaymentModal();

        } catch (error) {
            console.error("AJAX Error:", error);
            displayErrorBanner("Network error. Check your connection.");
        }

        confirmButton.disabled = false;
        confirmButton.textContent = actionType === 'unmark'
            ? "Unmark Payment"
            : "Confirm Payment";
    });
}

        // =========================================================================
        // V. EVENT LISTENERS SETUP
        // =========================================================================

        let selectedRow = null;
        rows.forEach(row => {
          row.addEventListener('click', (e) => {
            if (e.target.closest('.indicator')) return;
            if (selectedRow) selectedRow.classList.remove('row-selected');
            selectedRow = row;
            selectedRow.classList.add('row-selected');
          });
        });

        document.querySelectorAll('.payment-cell').forEach(cell => {
          cell.addEventListener('click', function(e) {
            if (e.target.closest('.indicator')) {
              e.stopPropagation();
            }
          });
        });

        const openPayButtons = document.querySelectorAll('.open-pay');
        openPayButtons.forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();

            const indicator = this;
            const currentStatus = indicator.textContent.trim();

            const unit = this.dataset.unit;
            const rent = this.dataset.rent;
            const id = this.dataset.id;
            const propertyName = this.dataset.propertyName;

            if (currentStatus === '+') {
                openUnmarkModal(unit, id, propertyName, rent);
            } else {
                openPaymentModal(unit, rent, id, propertyName);
            }
          });
        });

        // Initial Load Actions
        displayErrorBanner(null, true);
        applyFilters();
    });
</script>
</body>
</html>