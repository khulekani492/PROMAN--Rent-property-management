<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ProMan — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root{
          --bg: #f5f6f7;
          --surface: #ffffff;
          --muted: #eef0f2;
          --text: #2f3337;
          --muted-text: #6b7378;
          --accent: #D4AF37;
          --accent-dark: #b8892a;
          --sidebar-bg: #f1f3f4; /* Defined smokish white color */
        }

        html,body { height:100%; }
        body {
          margin:0;
          min-height:100%;
          background:var(--bg);
          color:var(--text);
          font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
          -webkit-font-smoothing:antialiased;
          -moz-osx-font-smoothing:grayscale;
          display:flex;
          flex-direction:column;
        }

        /* Header - Added white background */
        header.topbar {
          background: #ffffff; /* Changed to solid white */
          border-bottom: 1px solid var(--muted);
          position: sticky;
          top: 0;
          z-index: 60;
          height: 80px; /* Fixed header height */
        }
        header .brand-left { display:flex; gap:1rem; align-items:center; }
        header .brand-left img { height:5rem; width:auto; }
        header .brand-left a.text-accent { color: var(--accent); font-weight:800; font-size:1.125rem; }

        .main-wrap {
          display:flex;
          flex:1;
          min-height: calc(100vh - 80px); /* Adjusted for header height */
        }

        /* Sidebar: desktop visible; mobile overlays when opened - Enhanced smokish white background */
        .sidebar {
          width:16rem;
          min-height:100vh;
          position:fixed;
          left:0;
          top: 80px; /* Start below the header */
          z-index:50;
          overflow:auto;
          background: var(--sidebar-bg); /* Using defined smokish white */
          transition: transform .28s ease, box-shadow .28s ease;
          border-right: 1px solid rgba(0,0,0,0.08); /* Slightly darker border for better definition */
          transform: translateX(0); /* visible by default on desktop */
          /* Removed margin-top since we're using top positioning */
        }

        /* Desktop layout */
        @media (min-width:1025px) {
          .content {
            margin-left: 16rem;
            padding:1.5rem;
            padding-top:2rem; /* Reduced top padding since sidebar starts lower */
            width: calc(100% - 16rem); /* Ensure content takes remaining width */
          }
          #sidebar-backdrop { display:none; }
        }

        /* Mobile overlay behavior */
        @media (max-width:1024px) {
          .sidebar {
            transform: translateX(-100%);
            position:fixed;
            height: calc(100vh - 80px); /* Account for header height */
            left:0;
            top: 80px; /* Start below the header */
            box-shadow: 0 18px 40px rgba(16,24,40,0.12);
            /* Reset margin on mobile */
          }
          .sidebar.overlay-visible {
            transform: translateX(0);
            background: var(--sidebar-bg); /* Using defined smokish white */
          }
          .content {
            margin-left: 0;
            padding:1rem;
            padding-top:1.5rem; /* Reduced top padding */
            width: 100%; /* Full width on mobile */
          }
          #sidebar-backdrop {
            display:block;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.45);
            z-index:45;
            opacity:0;
            pointer-events:none;
            transition:opacity .18s ease;
          }
          #sidebar-backdrop.visible {
            opacity:1;
            pointer-events:auto;
          }
        }

        .sidebar .bg-white { background: var(--surface); }
        .sidebar .card {
          background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
          border:1px solid rgba(0,0,0,0.06);
          box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .feature-icon { width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background: rgba(212,175,55,0.08); color: var(--accent); }

        .nav-item {
          display:flex;
          align-items:center;
          gap:.75rem;
          padding:.75rem;
          border-radius:.5rem;
          color: rgba(47,51,55,0.85);
          text-decoration:none;
          transition: all 0.2s ease;
          background: rgba(255,255,255,0.5);
        }
        .nav-item:hover {
          background: rgba(255,255,255,0.8);
          color: var(--text);
          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .nav-item.active {
          background: rgba(212,175,55,0.1);
          border-left: 4px solid var(--accent);
          color: var(--text);
          box-shadow: 0 2px 6px rgba(212,175,55,0.1);
        }

        .card-surface { background: var(--surface); border-radius:.75rem; box-shadow: 0 18px 40px rgba(16,24,40,0.06); padding:1.25rem; border:1px solid rgba(0,0,0,0.04); }

        /* TABLE: keep table semantics on all sizes. Use horizontal scrolling on narrow screens. */
        .units-wrapper {
          width:100%;
          overflow-x:auto;
          -webkit-overflow-scrolling:touch;
          max-width: 100%; /* Ensure it doesn't overflow container */
        }
        .units-table {
          width:100%;
          min-width:760px; /* ensures readable columns on small screens; adjust as needed */
          border-collapse:separate;
          border-spacing:0;
          border-radius:.5rem;
          overflow:hidden;
          box-shadow: 0 8px 24px rgba(16,24,40,0.04);
        }
        .units-table thead th {
          background:#F7E9D4;
          color:var(--text);
          font-weight:700;
          padding:.75rem 1rem;
          text-align:left;
          border-bottom:1px solid rgba(210,180,140,0.6);
          position:sticky;
          top:0;
          z-index:10;
        }
        .units-table tbody td {
          background: var(--surface);
          padding:.75rem 1rem;
          border-bottom:1px solid rgba(0,0,0,0.04);
          color:var(--text);
          white-space:nowrap;
        }
        .units-table tbody tr:hover td { background:#FFF8F0; }
        .units-table tbody tr:nth-child(even) td { background:#FCF6ED; }

        .indicator { display:inline-flex; align-items:center; justify-content:center; width:1.9rem; height:1.9rem; border-radius:.5rem; font-weight:700; }
        .indicator.bg-red-100, .indicator.bg-red { background: rgba(255,69,58,0.08); color:#C53030; }
        .indicator.bg-green-100, .indicator.bg-green { background: rgba(16,185,129,0.08); color:#065f46; }

        /* On very small screens, reduce padding to fit more columns; table remains a table. */
        @media (max-width:480px) {
          .units-table thead th, .units-table tbody td { padding:.5rem .6rem; font-size:13px; }
          .card-surface { padding:1rem; }
        }

        .control-btn { padding:.65rem .85rem; border-radius:.5rem; font-weight:600; }

        /* Row selection styling */
        .row-selected {
          background-color: rgba(212,175,55,0.1) !important;
          outline: 2px solid var(--accent);
        }

        /* Ensure content area doesn't overflow */
        .content {
          box-sizing: border-box;
          overflow-x: hidden;
        }

        /* Mobile table adjustments */
        @media (max-width: 768px) {
          .units-table {
            min-width: 600px; /* Reduced minimum width for better mobile fit */
          }

          .flex-col-mobile {
            flex-direction: column;
          }

          .w-full-mobile {
            width: 100%;
          }
        }

        /* Sidebar header styling */
        .sidebar-header {
          background: var(--sidebar-bg); /* Using defined smokish white */
          padding: 1.5rem;
          border-bottom: 1px solid rgba(0,0,0,0.08);
          text-align: center;
        }

        /* Enhanced table styling */
        .tenant-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-placeholder {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9e9e9e;
        }

        .tenant-details {
            display: flex;
            flex-direction: column;
        }

        .tenant-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .tenant-contact {
            font-size: 12px;
            color: var(--muted-text);
        }

        .unit-details {
            display: flex;
            flex-direction: column;
        }

        .unit-number {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .unit-rent {
            font-size: 12px;
            color: var(--muted-text);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background-color: rgba(16,185,129,0.1);
            color: #065f46;
        }

        .status-pending {
            background-color: rgba(245,158,11,0.1);
            color: #92400e;
        }

        .status-vacant {
            background-color: rgba(239,68,68,0.1);
            color: #991b1b;
        }

        .edit-btn {
            background: transparent;
            border: none;
            color: #3b82f6;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
        }

        .edit-btn:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>

<body class="antialiased">
<header class="topbar">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="brand-left">
            <a href="home.html" class="flex items-center">
                <img src="/umuzi/img/mypromann.png" alt="ProMan logo" class="h-20 md:h-24 w-auto object-contain">
            </a>
            <div>
                <a href="home.html" class="text-accent font-extrabold text-xl">ProMan</a>
                <div class="text-xs" style="color:var(--muted-text); margin-top:-4px;">Property management simplified</div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="mobileMenuButton" aria-label="Toggle menu" aria-expanded="false"
                    class="lg:hidden p-2 rounded-lg bg-[var(--accent)] text-white mr-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>

            <nav class="hidden lg:flex items-center gap-3 text-sm font-medium">
                <a href="http://localhost:7070/" class="inline-flex items-center px-5 py-2.5 rounded-lg font-semibold shadow-lg bg-[var(--accent)] text-[#2b1f00] hover:bg-[var(--accent-dark)] transition">LOG OUT</a>
            </nav>
        </div>
    </div>
</header> <div id="sidebar-backdrop"></div>

<div class="main-wrap">
    <aside id="sidebar" class="sidebar" role="navigation" aria-label="Main sidebar">
        <div class="sidebar-header">

        </div>
        <nav class="p-4 space-y-2">
            <a href="http://localhost:7070/dashboard" class="nav-item active">Dashboard</a>
            <a href="http://localhost:7070/add_property_unit" class="nav-item">ADD UNIT</a>
        </nav>
        <div class="p-4 space-y-3">
            <div class="card rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm" style="color:rgba(47,51,55,0.7)">Total Properties</p>
                        <p class="text-lg font-bold" style="color:var(--text)">8</p>
                    </div>
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10"/></svg>
                    </div>
                </div>
                <p class="text-sm" style="color:rgba(47,51,55,0.6); margin-top:6px">+2 from last month</p>
            </div>

            <div class="card rounded-lg p-3" style="border-left-color: rgba(34,197,94,0.18);">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm" style="color:rgba(47,51,55,0.7)">Occupied Units</p>
                        <p class="text-lg font-bold" style="color:var(--text)">18</p>
                    </div>
                    <div class="feature-icon" style="background: rgba(255,255,255,0.06); color:var(--text)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4"/></svg>
                    </div>
                </div>
                <p class="text-sm" style="color:rgba(47,51,55,0.6); margin-top:6px">92% occupancy rate</p>
            </div>

            <div class="card rounded-lg p-3" style="border-left-color: rgba(59,130,246,0.18);">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm" style="color:rgba(47,51,55,0.7)">Vacant Units</p>
                        <p class="text-lg font-bold" style="color:var(--text)">2</p>
                    </div>
                    <div class="feature-icon" style="background: rgba(255,255,255,0.06); color:var(--text)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 12H4"/></svg>
                    </div>
                </div>
                <p class="text-sm" style="color:rgba(47,51,55,0.6); margin-top:6px">Available for rent</p>
            </div>

            <div class="card rounded-lg p-3" style="border-left-color: rgba(139,92,60,0.18);">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm" style="color:rgba(47,51,55,0.7)">Monthly Revenue</p>
                        <p class="text-lg font-bold" style="color:var(--text)">R42,500</p>
                    </div>
                    <div class="feature-icon" style="background: rgba(255,255,255,0.06); color:var(--text)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2"/></svg>
                    </div>
                </div>
                <p class="text-sm" style="color:rgba(47,51,55,0.6); margin-top:6px">+R2,500 from last month</p>
            </div>
        </div>
    </aside>

    <main class="content">
        <div class="p-6">
            <header class="mb-8">
                <h1 class="text-3xl font-bold" style="color:var(--accent)">Property Management</h1>
                <p class="text-[var(--muted-text)]">Manage your properties and tenant payments</p>
            </header>

            <div class="flex flex-col lg:flex-row gap-6">
                <div class="lg:w-1/3">
                    <div class="card-surface h-full">
                        <form id="propertyForm" action="http://localhost:7070/fetch_property_units" method="post">
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-[var(--muted-text)] mb-2">Property Name</label>
                                    <select id="propertySelect" name="name" class="w-full rounded-md border-gray-300 shadow-sm focus:ring-0 focus:border-[var(--accent)]">
                                        <option value="">Select property</option>
                                        <option value="all">All properties</option>
                                        <option th:each="name : ${names}" th:value="${name}" th:text="${name}">Default Name</option>
                                    </select>
                                </div>

                                <div>

                                </div>
                            </div>
                        </form>

                        <div class="mt-6">
                            <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center h-48">
                                <img src="/umuzi/img/mypromann.png" alt="Property image" class="max-h-full max-w-full object-contain">
                            </div>
                        </div>

                        <div class="mt-6">
                            <a href="http://localhost:7070/add_property_unit" class="inline-flex items-center gap-2 px-4 py-2 bg-[var(--accent)] text-[var(--text)] rounded-lg hover:bg-[var(--accent-dark)] transition font-medium">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                Add New Property
                            </a>
                        </div>

                        <p class="mt-4 text-sm text-[var(--muted-text)]">Tip: Select a row, then use the external controls (+ / -) to update only the Payment box. Overdue shows number of days overdue.</p>
                    </div>
                </div>

                <div class="lg:w-2/3">
                    <div class="card-surface h-full">
                        <div id="controlsWrapper" class="mb-4 flex flex-wrap gap-3 items-center">
                            <button id="btnPaid" type="button" class="control-btn bg-green-600 text-white">Mark Paid (+)</button>
                            <button id="btnUnpaid" type="button" class="control-btn bg-red-600 text-white">Mark Unpaid (-)</button>
                            <div class="text-sm text-[var(--muted-text)]">Select a row, then click a button to update the Payment box only.</div>
                        </div>

                        <div id="paymentErrorDisplay" class="hidden p-3 mb-4 rounded-md text-sm font-medium bg-red-100 text-red-800 border border-red-300" role="alert">
                        </div>
                        <p th:if="${unit != null and unit != ''}"
                           th:text="|You have already marked Unit ${unit} as paid this month.|" class="text-green-600 font-medium"></p>
                        <p th:if="${success != null and success != ''}"
                           th:text="|Unit ${success} marked as paid this month.|" class="text-green-600 font-medium"></p>
                        <div class="units-wrapper w-full overflow-x-auto">
                            <table class="units-table min-w-max w-full border-collapse">
                                <thead>
                                <tr>
                                    <th class="px-4 py-3 whitespace-nowrap">Tenant</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Unit Details</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Status</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Rent Day</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Overdue</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Payment</th>
                                    <th class="px-4 py-3 whitespace-nowrap">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="unitsTbody">
                                <tr th:each="entry : ${units}" class="hover:cursor-pointer">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="tenant-info">
                                            <div class="profile-placeholder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="12" cy="7" r="4"></circle>
                                                </svg>
                                            </div>
                                            <div class="tenant-details">
                                                <div class="tenant-name" th:text="${entry.value[3]}">Tenant Name</div>
                                                <div class="tenant-contact">Contact info</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="unit-details">
                                            <div class="unit-number" th:text="${entry.value[0]}">Unit Number</div>
                                            <div class="unit-rent" th:text="'R ' + ${entry.value[1]}">Rent Amount</div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span th:if="${entry.value[2]} == 'yes'" class="status-badge status-active">Occupied</span>
                                        <span th:if="${entry.value[2]} == 'no'" class="status-badge status-vacant">Vacant</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap unit-tenant" th:text="${entry.value[4]}">Rent Day</td>
                                    <td class="px-4 py-3 whitespace-nowrap unit-tenant" th:text="${entry.value[5]}">Overdue Days</td>
                                    <td class="px-4 py-3 whitespace-nowrap payment-cell">
    <span th:if="${entry.value[2]} == 'yes'"
          th:with="isPaid=${entry.value[6]}"
          th:classappend="${isPaid} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
          class="indicator open-pay cursor-pointer"
          th:data-unit="${entry.value[0]}" th:data-rent="${entry.value[1]}"
          th:data-id="${entry.value[3]}" th:data-property-name="${propertyName}"
          th:text="${isPaid} ? '+' : '−'">−</span>
                                        <span th:if="${entry.value[2]} == 'no'" class="indicator bg-red-100 text-red-800">−</span>
                                    </td>
                                        <span th:if="${entry.value[2]} == 'no'" class="indicator bg-red-100 text-red-800">−</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <button class="edit-btn">Edit</button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-60">
    <div class="modal-card w-96 text-center">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-3">Update Payment Status</h2>
            <p class="text-gray-700 mb-2">Unit: <span id="modalUnitDisplay" class="font-bold"></span></p>
            <p class="text-gray-700 mb-4 text-sm">Original Rent: <span id="modalOriginalRent" class="font-bold"></span></p>
            <form id="paymentForm" method="post">
                <input type="hidden" name="unit" id="modalUnit">
                <input type="hidden" name="id" id="modalId">
                <input type="hidden" name="property_name" id="modalPropertyName">
                <input type="hidden" name="paid" value="yes">
                <div class="mb-4 text-left">
                    <label for="modalRentInput" class="block text-sm font-medium text-[var(--muted-text)] mb-2">Rent Paid Amount:</label>
                    <input type="number" id="modalRentInput" name="rent" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent" placeholder="Enter rent amount">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition">Confirm Payment</button>
                    <button type="button" onclick="closePaymentModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-medium transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Global function to display errors in the new banner
    const errorDisplay = document.getElementById('paymentErrorDisplay');
    function displayErrorBanner(message, isClear = false) {
        if (isClear || !message) {
            errorDisplay.classList.add('hidden');
            errorDisplay.textContent = '';
        } else {
            // Use 'alert' style for high visibility
            errorDisplay.textContent = message;
            errorDisplay.classList.remove('hidden');
        }
        // Also ensure temporary flash message is used for confirmation/quick tips
        flashMessage(message, 'red');
    }

    // Sidebar overlay handling (desktop visible by default)
    const mobileMenuButton = document.getElementById('mobileMenuButton');
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('sidebar-backdrop');

    function openSidebarOverlay() {
      if (!sidebar) return;
      sidebar.classList.add('overlay-visible');
      if (backdrop) backdrop.classList.add('visible');
      if (mobileMenuButton) mobileMenuButton.setAttribute('aria-expanded','true');
    }
    function closeSidebarOverlay() {
      if (!sidebar) return;
      sidebar.classList.remove('overlay-visible');
      if (backdrop) backdrop.classList.remove('visible');
      if (mobileMenuButton) mobileMenuButton.setAttribute('aria-expanded','false');
    }

    function ensureSidebarDesktop() {
      if (!sidebar) return;
      if (window.innerWidth > 1024) {
        sidebar.classList.remove('overlay-visible');
        if (backdrop) backdrop.classList.remove('visible');
        sidebar.style.transform = 'translateX(0)';
      } else {
        sidebar.style.transform = '';
        sidebar.classList.remove('overlay-visible');
        if (backdrop) backdrop.classList.remove('visible');
      }
    }

    if (mobileMenuButton && sidebar) {
      ensureSidebarDesktop();

      mobileMenuButton.addEventListener('click', (e) => {
        const isOpen = sidebar.classList.contains('overlay-visible');
        if (isOpen) closeSidebarOverlay(); else openSidebarOverlay();
        e.stopPropagation();
      });

      if (backdrop) backdrop.addEventListener('click', closeSidebarOverlay);

      sidebar.querySelectorAll('a').forEach(a => {
        a.addEventListener('click', () => {
          if (window.innerWidth <= 1024) closeSidebarOverlay();
        });
      });

      window.addEventListener('resize', ensureSidebarDesktop);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebarOverlay(); });
    }

    /* existing dashboard JS preserved */
    const propertySelect = document.getElementById('propertySelect');
    const tbody = document.getElementById('unitsTbody');
    const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

    function applyFilters() {
      const prop = propertySelect ? propertySelect.value : '';
      rows.forEach(row => {
        const rowProp = row.dataset.property || '';
        const matchesProp = (prop === 'all') || (rowProp === prop) || !prop;
        row.style.display = matchesProp ? '' : 'none';
      });
    }

    if (propertySelect) propertySelect.addEventListener('change', applyFilters);

    let selectedRow = null;
    function clearSelection() {
      if (!selectedRow) return;
      selectedRow.classList.remove('row-selected');
      selectedRow = null;
    }

    rows.forEach(row => {
      row.addEventListener('click', (e) => {
        if (e.target.closest('.indicator')) return;
        if (selectedRow) selectedRow.classList.remove('row-selected');
        selectedRow = row;
        selectedRow.classList.add('row-selected');
      });
    });

    const btnPaid = document.getElementById('btnPaid');
    const btnUnpaid = document.getElementById('btnUnpaid');

    function updatePaymentForRow(row, paid) {
      const paymentIndicator = row.querySelector('.payment-cell .indicator');
      if (!paymentIndicator) return;
      if (paid) {
        paymentIndicator.textContent = '+';
        paymentIndicator.classList.remove('bg-red-100', 'text-red-800');
        paymentIndicator.classList.add('bg-green-100', 'text-green-800');
        paymentIndicator.setAttribute('aria-label', 'Payment: yes');
      } else {
        paymentIndicator.textContent = '-';
        paymentIndicator.classList.remove('bg-green-100', 'text-green-800');
        paymentIndicator.classList.add('bg-red-100', 'text-red-800');
        paymentIndicator.setAttribute('aria-label', 'Payment: no');
      }
    }

    function togglePaymentStatus(paymentCell) {
      const paymentIndicator = paymentCell.querySelector('.indicator');
      if (!paymentIndicator) return;
      const isPaid = paymentIndicator.textContent === '+';
      updatePaymentForRow(paymentCell.closest('tr'), !isPaid);
      flashMessage(`Payment status ${!isPaid ? 'set to paid (+)' : 'set to unpaid (-)'}`, !isPaid ? 'green' : 'red');
    }

    document.querySelectorAll('.payment-cell').forEach(cell => {
      cell.addEventListener('click', function(e) {
        if (e.target.closest('.indicator')) {
          togglePaymentStatus(this);
        }
      });
    });

    function flashMessage(msg, color = 'yellow') {
      const el = document.createElement('div');
      el.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md text-sm font-medium ${
        color === 'green' ? 'bg-green-100 text-green-800' :
        color === 'red' ? 'bg-red-100 text-red-800' :
        'bg-yellow-100 text-yellow-800'
      }`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1600);
    }

    if (btnPaid) btnPaid.addEventListener('click', () => {
      if (!selectedRow) return flashMessage('No row selected — click a row first.', 'yellow');
      updatePaymentForRow(selectedRow, true);
      flashMessage('Payment set to + (paid).', 'green');
    });

    if (btnUnpaid) btnUnpaid.addEventListener('click', () => {
      if (!selectedRow) return flashMessage('No row selected — click a row first.', 'yellow');
      updatePaymentForRow(selectedRow, false);
      flashMessage('Payment set to - (unpaid).', 'red');
    });

    if (propertySelect) {
      propertySelect.addEventListener('change', function () {
        const selectedValue = this.value;
        if (selectedValue && selectedValue !== 'all') {
          document.getElementById('propertyForm').submit();
        }
      });
    }

    // Payment modal variables
    const paymentModal = document.getElementById('paymentModal');
    const modalUnitDisplay = document.getElementById('modalUnitDisplay');
    const modalOriginalRent = document.getElementById('modalOriginalRent');
    const modalUnit = document.getElementById('modalUnit');
    const modalId = document.getElementById('modalId');
    const modalPropertyName = document.getElementById('modalPropertyName');
    const modalRentInput = document.getElementById('modalRentInput');
    const paymentForm = document.getElementById('paymentForm');

    // UPDATED openPaymentModal function
    function openPaymentModal(unit, rent, id, propertyName) {
      // Clear any previous error banner before opening the modal
      displayErrorBanner(null, true);

      if (!modalUnitDisplay) return;
      modalUnitDisplay.textContent = unit;
      modalOriginalRent.textContent = rent;

      // Set hidden input values
      if (modalUnit) modalUnit.value = unit;
      if (modalId) modalId.value = id;
      if (modalPropertyName) modalPropertyName.value = propertyName;
      // Clean rent string ('R 1000' -> '1000') for the number input field
      if (modalRentInput) modalRentInput.value = rent.replace('R ', '').replace(/,/g, '');

      // Removed previous paymentForm.action assignment; handled by fetch listener

      if (modalRentInput) modalRentInput.focus();
      if (paymentModal) {
        paymentModal.classList.remove('hidden');
        paymentModal.classList.add('flex');
      }
    }

    function closePaymentModal() {
      if (!paymentModal) return;
      paymentModal.classList.add('hidden');
      paymentModal.classList.remove('flex');
    }

    // ⭐ NEW ASYNCHRONOUS FORM SUBMISSION LOGIC (WITH CONSOLE LOG) ⭐
    if (paymentForm) {
      paymentForm.addEventListener('submit', async (event) => {
        // 1. Stop the default page reload
        event.preventDefault();
        displayErrorBanner(null, true); // Clear error on submission attempt

        // 2. Get form data and construct the URL
        const formData = new FormData(paymentForm);
        const tenantName = formData.get('id');
        const unit = formData.get('unit');

        // Debugging logs to ensure values are correct before fetch
        console.log("Debug: Attempting to send payment form data.");
        console.log("Debug: Tenant ID (id):", tenantName);
        console.log("Debug: Unit Number (unit):", unit);

        const url = `http://localhost:7070/payment_status/${tenantName}/${unit}`;
        console.log("Debug: Target URL:", url);


        try {
          // 3. Send the POST request
          const response = await fetch(url, {
            method: 'POST',
            body: new URLSearchParams(formData),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
          });

          // Debugging log to confirm a response was received
          console.log(`Debug: Received response status: ${response.status}`);

          // 4. Handle server response
          if (response.ok) {
            // Log for debugging confirmation
            console.log("form sent successfully");

            flashMessage(`Unit ${unit} marked as paid successfully!`, 'green');

            // OPTIONAL: Visually update the table cell immediately
            const indicator = document.querySelector(`.open-pay[data-unit="${unit}"][data-id="${tenantName}"]`);
            if (indicator) {
              indicator.textContent = '+';
              indicator.classList.remove('bg-red-100', 'text-red-800');
              indicator.classList.add('bg-green-100', 'text-green-800');
              indicator.setAttribute('aria-label', 'Payment: yes');
            }

            closePaymentModal();

          } else {
            // Read error message from backend
            const errorText = await response.text();
            console.error(`Error: Server responded with status ${response.status}`, errorText);

            // Determine user-friendly error message
            let userMessage = `Payment failed (Status: ${response.status}). Check server logs.`;

            // ⭐ CUSTOM LOGIC TO CATCH DUPLICATE PAYMENT MESSAGE ⭐
            // We assume the server returns a body containing "Payment already recorded for this month."
            if (errorText.includes('Payment already recorded for this month.')) {
                userMessage = `Payment already recorded for Unit ${unit} this month.`;
                displayErrorBanner(userMessage);
            }
            // If the Java code redirected on error (302) or returned a generic error (500)
            else if (response.status >= 400) {
                userMessage = `Payment failed (Status: ${response.status}). Details: ${errorText.substring(0, 50)}...`;
                displayErrorBanner(userMessage);
            }

            // If the error happens inside the modal, keep the modal open and show the error.
            // If you want the modal to close: closePaymentModal();
            flashMessage(userMessage, 'red'); // Still show a temporary flash message

          }

        } catch (error) {
          // Handle network errors (CORS, server down)
          console.error("Network Error during fetch:", error);
          const networkError = `A network error occurred. Server unreachable or CORS block.`;
          displayErrorBanner(networkError);
          // If a network error occurs, we typically don't close the modal immediately
          flashMessage(networkError, 'red');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const openPayButtons = document.querySelectorAll('.open-pay');
      openPayButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const unit = this.dataset.unit;
          const rent = this.dataset.rent;
          const id = this.dataset.id;
          const propertyName = this.dataset.propertyName;

          if (!unit || !rent || !id || !propertyName) {
            const row = this.closest('tr');
            // Using correct class names for robust selection
            const unitCell = row.querySelector('.unit-number');
            const rentCell = row.querySelector('.unit-rent');
            const idCell = row.querySelector('.tenant-name');
            const propertySelect = document.getElementById('propertySelect');

            openPaymentModal(
              unit || (unitCell ? unitCell.textContent : ''),
              rent || (rentCell ? rentCell.textContent : ''),
              id || (idCell ? idCell.textContent : ''),
              propertyName || (propertySelect ? propertySelect.value : 'default')
            );
          } else {
            openPaymentModal(unit, rent, id, propertyName);
          }
        });
      });

      // Clear any leftover Thymeleaf success/error messages on page load if they exist
      displayErrorBanner(null, true);
      applyFilters();
    });
</script>
</body>
</html>